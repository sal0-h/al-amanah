# AI Coding Instructions - Al-Amanah

- **Architecture**: FastAPI backend + React/Vite frontend + SQLite, served by nginx (Docker Compose). Core hierarchy is Semester → Week → Event → Task.
- **Auth**: Session cookies (itsdangerous), not JWT. Use `get_current_user` / `get_admin_user` in [backend/app/middleware/auth.py](backend/app/middleware/auth.py). Frontend already sends `credentials: 'include'` via [frontend/src/api/client.ts](frontend/src/api/client.ts).
- **Roles & visibility**: Admins see all. Members see tasks where they are assigned, on their team, or in TaskAssignment pool. Non-roster users see an empty dashboard even with an active semester; filtering implemented in [backend/app/routers/dashboard.py](backend/app/routers/dashboard.py).
- **Semesters & roster gate**: Only one semester can be active; new/updated active semester deactivates others in [backend/app/routers/semesters.py](backend/app/routers/semesters.py). Users must be added to `RosterMember` for the active semester (see [backend/app/routers/roster.py](backend/app/routers/roster.py)) to view/act on tasks.
- **Task assignment model**: Three paths checked in `can_modify_task()` in [backend/app/routers/tasks.py](backend/app/routers/tasks.py): `assigned_to` user, `assigned_team_id` (any team member), TaskAssignment pool (`assigned_user_ids`). Changing assignment resets status to PENDING; `completed_by` records who acted.
- **Task statuses**: Flow PENDING → DONE or CANNOT_DO (with reason and Discord admin alert) → PENDING via undo. Task types: STANDARD (must be done) vs SETUP (informational). Assignee name resolution is single user → team → pool count; canonical logic in `task_to_out()` in [backend/app/routers/tasks.py](backend/app/routers/tasks.py) and mirrored in [backend/app/routers/dashboard.py](backend/app/routers/dashboard.py).
- **Templates**: Hardcoded plus DB templates (id prefix `db_`) in [backend/app/routers/templates.py](backend/app/routers/templates.py). Week templates expand by week start + `day_of_week` + `default_time`. Missing template teams raise 400 before creation.
- **Scheduler & Discord**: APScheduler hourly job in [backend/app/services/scheduler.py](backend/app/services/scheduler.py) uses Qatar TZ (UTC+3) and one-time `auto_reminder_sent`. Manual reminders via POST `/api/tasks/{id}/send-reminder` and POST `/api/events/{id}/send-all-reminders`. Webhooks from `.env` (`REMINDER_WEBHOOK_URL`, `ADMIN_WEBHOOK_URL`); tests set `DISCORD_ENABLED=False`.
- **Frontend conventions**: Tailwind dark mode (`dark:`) everywhere; keep EventCard/TaskRow memoized inside [frontend/src/pages/Dashboard.tsx](frontend/src/pages/Dashboard.tsx) and use optimistic updates with rollback on API errors. Types in [frontend/src/types/index.ts](frontend/src/types/index.ts) should mirror Pydantic outputs.
- **Dev commands**: `docker-compose up -d --build` (full stack). Backend: `cd backend && uvicorn app.main:app --reload` after `pip install -r requirements.txt`. Frontend: `cd frontend && npm install && npm run dev` on :5173. Tests: `cd backend && pytest`; `cd frontend && npm test`.
- **Gotchas**: Discord IDs must be numeric. nginx binds port 80. SQLite persists in ./data (wipe if deleted). Cloudflare tunnel is auto-accepted for CORS/HTTPS. When changing task status, log via `log_action` in [backend/app/services/audit.py](backend/app/services/audit.py).
- **API highlights**: Task reminders: POST `/api/tasks/{id}/send-reminder` and POST `/api/events/{id}/send-all-reminders`. Batch users: POST `/api/users/batch` (password defaults to username if omitted). Export/import: GET `/api/export/semester/{id}`, GET `/api/export/all`, POST `/api/export/import?skip_existing=`.
- **UI patterns**: Forms often force remount with `key` props to reset state; maintain dark/light assets (`/images/MSA_main_clear.png`, `/images/White_Clear.png`). Dashboard is the only data source for non-admins; admin-only stats/audit routes require auth.
- **Data shaping**: Use `*_to_out` helpers (e.g., `task_to_out`) to hydrate assignee lists, assignee display names, and ISO timestamps before returning responses; reuse to keep frontend/backends in sync.
- **Testing**: Backend pytest suite in-memory SQLite per test via fixtures in [backend/tests/conftest.py](backend/tests/conftest.py); frontend uses Vitest + React Testing Library with mocked API calls in [frontend/tests](frontend/tests).
- **Deployment**: Primary path is Docker Compose. For quick HTTPS, run Cloudflare tunnel against nginx on port 80; CORS allows HTTPS origins automatically.
- **Audit trail**: User-facing status changes (done/cannot-do/undo) must call `log_action`; see usage in [backend/app/routers/tasks.py](backend/app/routers/tasks.py).